<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico Completo - Charla IA Producci√≥n</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .test-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #007cba;
        }
        .button {
            background: linear-gradient(45deg, #007cba, #0056b3);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0,124,186,0.3);
        }
        .button:hover {
            background: linear-gradient(45deg, #0056b3, #003d82);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,124,186,0.4);
        }
        .button.danger {
            background: linear-gradient(45deg, #dc3545, #c82333);
        }
        .button.danger:hover {
            background: linear-gradient(45deg, #c82333, #bd2130);
        }
        .button.success {
            background: linear-gradient(45deg, #28a745, #20c997);
        }
        .result {
            background: #1e1e1e;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: 'Consolas', 'Monaco', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #444;
        }
        .success { color: #50fa7b; }
        .error { color: #ff5555; }
        .warning { color: #f1fa8c; }
        .info { color: #8be9fd; }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-ok { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-warning { background: #ffc107; }
        .urls-list {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .urls-list h4 {
            margin-top: 0;
            color: #495057;
        }
        .url-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
            padding: 8px;
            background: white;
            border-radius: 5px;
            border-left: 3px solid #007cba;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #007cba, #0056b3);
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Diagn√≥stico Completo - Charla IA</h1>
            <p>Sistema de diagn√≥stico avanzado para resolver problemas de producci√≥n</p>
            <div id="environment-info"></div>
        </div>

        <div class="test-grid">
            <div class="test-card">
                <h3>üéØ URLs del Backend</h3>
                <div class="urls-list">
                    <div class="url-item">
                        <span class="status-indicator" id="status-status"></span>
                        <strong>Status Simple:</strong> https://phprubensans.wuaze.com/status.php
                    </div>
                    <div class="url-item">
                        <span class="status-indicator" id="status-api"></span>
                        <strong>API Limpia:</strong> https://phprubensans.wuaze.com/api.php
                    </div>
                    <div class="url-item">
                        <span class="status-indicator" id="status-simple"></span>
                        <strong>Simple Test:</strong> https://phprubensans.wuaze.com/simple-test.php
                    </div>
                    <div class="url-item">
                        <span class="status-indicator" id="status-index"></span>
                        <strong>Index Principal:</strong> https://phprubensans.wuaze.com/index.php
                    </div>
                </div>
            </div>

            <div class="test-card">
                <h3>üß™ Tests Diagn√≥sticos</h3>
                <button class="button" onclick="testConnectivity()">üåê Test Conectividad</button>
                <button class="button" onclick="testCORS()">üîí Test CORS</button>
                <button class="button" onclick="testBackendFiles()">üìÅ Test Archivos Backend</button>
                <button class="button success" onclick="runFullDiagnostic()">üöÄ Diagn√≥stico Completo</button>
            </div>

            <div class="test-card">
                <h3>üîß Herramientas</h3>
                <button class="button" onclick="testCharlaIntegration()">üí¨ Test Integraci√≥n Charla</button>
                <button class="button" onclick="simulateProduction()">üåç Simular Producci√≥n</button>
                <button class="button danger" onclick="clearLogs()">üóëÔ∏è Limpiar Logs</button>
            </div>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progress"></div>
        </div>

        <div id="results" class="result">üöÄ Listo para ejecutar diagn√≥sticos...\n\nEste sistema probar√° todos los endpoints del backend y diagnosticar√° problemas de CORS, conectividad y configuraci√≥n.\n\nHaz clic en cualquier bot√≥n para comenzar.</div>
    </div>

    <script>
        // Variables globales
        const resultsDiv = document.getElementById('results');
        const progressBar = document.getElementById('progress');
        let testCount = 0;
        let totalTests = 0;

        // URLs del backend
        const backendUrls = {
            status: 'https://phprubensans.wuaze.com/status.php',
            api: 'https://phprubensans.wuaze.com/api.php',
            simple: 'https://phprubensans.wuaze.com/simple-test.php',
            index: 'https://phprubensans.wuaze.com/index.php'
        };

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            updateEnvironmentInfo();
            log('üéØ Sistema de diagn√≥stico inicializado');
            log('üìç Ubicaci√≥n: ' + window.location.href);
            log('üïí Timestamp: ' + new Date().toLocaleString());
        });

        function updateEnvironmentInfo() {
            const envInfo = document.getElementById('environment-info');
            const isProduction = window.location.hostname !== 'localhost';
            envInfo.innerHTML = `
                <p><strong>Entorno:</strong> ${isProduction ? 'üåç Producci√≥n' : 'üè† Local'}</p>
                <p><strong>Host:</strong> ${window.location.hostname}</p>
                <p><strong>Protocolo:</strong> ${window.location.protocol}</p>
            `;
        }

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const classes = { success: 'success', error: 'error', warning: 'warning', info: 'info' };
            const icon = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', info: 'üí°' };
            
            resultsDiv.innerHTML += `[${timestamp}] ${icon[type] || 'üìù'} <span class="${classes[type]}">${message}</span>\n`;
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        function updateProgress() {
            const percentage = totalTests > 0 ? (testCount / totalTests) * 100 : 0;
            progressBar.style.width = percentage + '%';
        }

        function updateStatus(endpoint, success) {
            const indicator = document.getElementById(`status-${endpoint}`);
            if (indicator) {
                indicator.className = `status-indicator ${success ? 'status-ok' : 'status-error'}`;
            }
        }

        async function testURL(name, url, method = 'GET', body = null) {
            try {
                log(`üîç Probando ${name}: ${url}`);
                
                const options = {
                    method: method,
                    mode: 'cors',
                    headers: {
                        'Accept': 'application/json, text/plain, */*',
                        'User-Agent': 'CharlaAI-Diagnostic/1.0'
                    }
                };

                if (method === 'POST' && body) {
                    options.headers['Content-Type'] = 'application/json';
                    options.body = JSON.stringify(body);
                }

                const startTime = Date.now();
                const response = await fetch(url, options);
                const endTime = Date.now();
                const duration = endTime - startTime;
                
                log(`üì° Status: ${response.status} ${response.statusText} (${duration}ms)`);
                
                const contentType = response.headers.get('content-type') || 'unknown';
                log(`üìÑ Content-Type: ${contentType}`);
                
                // Verificar headers CORS
                const corsOrigin = response.headers.get('access-control-allow-origin');
                const corsMethods = response.headers.get('access-control-allow-methods');
                log(`üîí CORS Origin: ${corsOrigin || 'NO CONFIGURADO'}`, corsOrigin ? 'success' : 'warning');
                log(`üîí CORS Methods: ${corsMethods || 'NO CONFIGURADO'}`, corsMethods ? 'success' : 'warning');
                
                const responseText = await response.text();
                
                // Detectar interceptaci√≥n por protecci√≥n
                const isIntercepted = responseText.includes('<script') || 
                                   responseText.includes('toNumbers') || 
                                   responseText.includes('protection') ||
                                   responseText.includes('cloudflare');
                
                if (response.ok) {
                    if (isIntercepted) {
                        log(`‚ùå ${name}: Interceptado por sistema de protecci√≥n`, 'error');
                        log(`üîß Respuesta contiene c√≥digo de protecci√≥n`, 'warning');
                        log(`üìÑ Muestra: ${responseText.substring(0, 150)}...`, 'warning');
                        return { success: false, intercepted: true, response: responseText };
                    } else {
                        log(`‚úÖ ${name}: OK`, 'success');
                        log(`üìù Respuesta: ${responseText.substring(0, 200)}${responseText.length > 200 ? '...' : ''}`);
                        return { success: true, response: responseText, duration };
                    }
                } else {
                    log(`‚ùå ${name}: Error HTTP ${response.status}`, 'error');
                    log(`üìù Error: ${responseText.substring(0, 200)}`, 'error');
                    return { success: false, error: `HTTP ${response.status}`, response: responseText };
                }
                
            } catch (error) {
                log(`‚ùå ${name}: ${error.message}`, 'error');
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    log(`üîß Posible problema de CORS o conexi√≥n de red`, 'warning');
                }
                return { success: false, error: error.message };
            } finally {
                testCount++;
                updateProgress();
                log(''); // L√≠nea vac√≠a
            }
        }

        async function testConnectivity() {
            resultsDiv.innerHTML = 'üåê Iniciando test de conectividad...\n\n';
            testCount = 0;
            totalTests = 4;
            
            log('=== TEST DE CONECTIVIDAD ===');
            
            const results = {};
            for (const [key, url] of Object.entries(backendUrls)) {
                const result = await testURL(`Conectividad ${key.toUpperCase()}`, url);
                results[key] = result;
                updateStatus(key, result.success);
            }
            
            // Resumen
            const successful = Object.values(results).filter(r => r.success).length;
            log(`üìä Resumen Conectividad: ${successful}/${totalTests} exitosos`);
            
            if (successful === 0) {
                log('üö® ALERTA: Ning√∫n endpoint responde correctamente', 'error');
                log('üí° Posibles causas:', 'warning');
                log('   - Archivos no subidos al servidor', 'warning');
                log('   - Problema de DNS o hosting', 'warning');
                log('   - Firewall bloqueando conexiones', 'warning');
            }
        }

        async function testCORS() {
            resultsDiv.innerHTML = 'üîí Iniciando test espec√≠fico de CORS...\n\n';
            testCount = 0;
            totalTests = 6;
            
            log('=== TEST ESPEC√çFICO DE CORS ===');
            
            // Test OPTIONS preflight
            for (const [key, url] of Object.entries(backendUrls)) {
                try {
                    log(`üîç OPTIONS preflight para ${key.toUpperCase()}: ${url}`);
                    const response = await fetch(url, { method: 'OPTIONS', mode: 'cors' });
                    log(`üì° OPTIONS Status: ${response.status}`);
                    
                    const corsHeaders = {
                        'access-control-allow-origin': response.headers.get('access-control-allow-origin'),
                        'access-control-allow-methods': response.headers.get('access-control-allow-methods'),
                        'access-control-allow-headers': response.headers.get('access-control-allow-headers')
                    };
                    
                    log(`üîí Headers CORS encontrados:`, 'info');
                    for (const [header, value] of Object.entries(corsHeaders)) {
                        log(`   ${header}: ${value || 'NO PRESENTE'}`, value ? 'success' : 'error');
                    }
                    
                } catch (error) {
                    log(`‚ùå ERROR OPTIONS ${key}: ${error.message}`, 'error');
                }
                
                testCount++;
                updateProgress();
                log('');
            }
        }

        async function testBackendFiles() {
            resultsDiv.innerHTML = 'üìÅ Iniciando test de archivos backend...\n\n';
            testCount = 0;
            totalTests = 8;
            
            log('=== TEST DE ARCHIVOS BACKEND ===');
            
            // Test GET requests
            log('--- FASE 1: Requests GET ---');
            for (const [key, url] of Object.entries(backendUrls)) {
                const result = await testURL(`GET ${key.toUpperCase()}`, url, 'GET');
                updateStatus(key, result.success);
            }
            
            // Test POST requests (solo para API y index)
            log('--- FASE 2: Requests POST ---');
            const postEndpoints = ['api', 'index'];
            for (const key of postEndpoints) {
                if (backendUrls[key]) {
                    const result = await testURL(
                        `POST ${key.toUpperCase()}`, 
                        backendUrls[key], 
                        'POST', 
                        { message: 'Test desde diagn√≥stico', timestamp: Date.now() }
                    );
                }
            }
        }

        async function testCharlaIntegration() {
            resultsDiv.innerHTML = 'üí¨ Iniciando test de integraci√≥n Charla...\n\n';
            testCount = 0;
            totalTests = 3;
            
            log('=== TEST INTEGRACI√ìN CHARLA ===');
            
            // Verificar si existe la clase CharlaAI
            if (typeof CharlaAI !== 'undefined') {
                log('‚úÖ Clase CharlaAI encontrada', 'success');
                
                try {
                    // Simular inicializaci√≥n
                    log('üîß Simulando inicializaci√≥n de CharlaAI...');
                    const testCharla = new CharlaAI();
                    log('‚úÖ CharlaAI inicializada correctamente', 'success');
                    
                    // Test de configuraci√≥n
                    log('‚öôÔ∏è Configuraci√≥n detectada:');
                    log(`   API URL: ${testCharla.config.apiUrl}`, 'info');
                    log(`   Mensaje de bienvenida: ${testCharla.config.welcomeMessage.substring(0, 50)}...`, 'info');
                    
                } catch (error) {
                    log(`‚ùå Error inicializando CharlaAI: ${error.message}`, 'error');
                }
            } else {
                log('‚ùå Clase CharlaAI no encontrada', 'error');
                log('üí° Verifica que charla.js est√© cargado correctamente', 'warning');
            }
            
            testCount = totalTests;
            updateProgress();
        }

        async function simulateProduction() {
            resultsDiv.innerHTML = 'üåç Simulando entorno de producci√≥n...\n\n';
            
            log('=== SIMULACI√ìN PRODUCCI√ìN ===');
            log('üîß Simulando request desde GitHub Pages a InfinityFree...');
            
            // Simular headers t√≠picos de GitHub Pages
            const productionTest = await testURL(
                'Simulaci√≥n Producci√≥n',
                backendUrls.api,
                'POST',
                { 
                    message: 'Test desde GitHub Pages',
                    source: 'github-pages',
                    timestamp: Date.now(),
                    userAgent: 'GitHub-Pages-Test'
                }
            );
            
            if (productionTest.success) {
                log('üéâ La simulaci√≥n de producci√≥n fue exitosa', 'success');
                log('‚úÖ El backend deber√≠a funcionar desde GitHub Pages', 'success');
            } else {
                log('‚ùå La simulaci√≥n de producci√≥n fall√≥', 'error');
                log('üîß El problema persiste en el entorno de producci√≥n', 'warning');
            }
        }

        async function runFullDiagnostic() {
            resultsDiv.innerHTML = 'üöÄ Iniciando diagn√≥stico completo del sistema...\n\n';
            testCount = 0;
            totalTests = 20;
            
            log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
            log('‚ïë        DIAGN√ìSTICO COMPLETO          ‚ïë');
            log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
            
            // Fase 1: Conectividad
            log('üåê FASE 1: Test de Conectividad');
            log('‚îÄ'.repeat(40));
            const connectivityResults = {};
            for (const [key, url] of Object.entries(backendUrls)) {
                const result = await testURL(`Conectividad ${key}`, url);
                connectivityResults[key] = result;
                updateStatus(key, result.success);
            }
            
            // Fase 2: CORS
            log('üîí FASE 2: Verificaci√≥n CORS');
            log('‚îÄ'.repeat(40));
            const corsResults = {};
            for (const [key, url] of Object.entries(backendUrls)) {
                try {
                    const response = await fetch(url, { method: 'OPTIONS', mode: 'cors' });
                    const hasValidCors = response.headers.get('access-control-allow-origin') !== null;
                    corsResults[key] = hasValidCors;
                    log(`${hasValidCors ? '‚úÖ' : '‚ùå'} CORS ${key}: ${hasValidCors ? 'OK' : 'Falta configuraci√≥n'}`, hasValidCors ? 'success' : 'error');
                } catch (error) {
                    corsResults[key] = false;
                    log(`‚ùå CORS ${key}: Error - ${error.message}`, 'error');
                }
                testCount++;
                updateProgress();
            }
            
            // Fase 3: Funcionalidad POST
            log('üì§ FASE 3: Test POST Requests');
            log('‚îÄ'.repeat(40));
            const postResults = {};
            const postEndpoints = ['api', 'index'];
            for (const key of postEndpoints) {
                if (backendUrls[key]) {
                    const result = await testURL(
                        `POST ${key}`,
                        backendUrls[key],
                        'POST',
                        { message: 'Test completo', diagnostic: true }
                    );
                    postResults[key] = result;
                }
            }
            
            // Fase 4: Integraci√≥n
            log('üí¨ FASE 4: Test Integraci√≥n');
            log('‚îÄ'.repeat(40));
            const hasCharlaAI = typeof CharlaAI !== 'undefined';
            log(`${hasCharlaAI ? '‚úÖ' : '‚ùå'} CharlaAI: ${hasCharlaAI ? 'Disponible' : 'No encontrada'}`, hasCharlaAI ? 'success' : 'error');
            testCount += 4;
            updateProgress();
            
            // Resumen final
            log('üìä RESUMEN FINAL');
            log('‚ïê'.repeat(40));
            
            const connectivityCount = Object.values(connectivityResults).filter(r => r.success).length;
            const corsCount = Object.values(corsResults).filter(r => r).length;
            const postCount = Object.values(postResults).filter(r => r.success).length;
            
            log(`üåê Conectividad: ${connectivityCount}/${Object.keys(backendUrls).length} OK`);
            log(`üîí CORS: ${corsCount}/${Object.keys(backendUrls).length} OK`);
            log(`üì§ POST Requests: ${postCount}/${postEndpoints.length} OK`);
            log(`üí¨ Integraci√≥n: ${hasCharlaAI ? '1/1' : '0/1'} OK`);
            
            const totalOk = connectivityCount + corsCount + postCount + (hasCharlaAI ? 1 : 0);
            const totalPossible = Object.keys(backendUrls).length * 3 + 1;
            
            log('');
            if (totalOk === totalPossible) {
                log('üéâ ¬°DIAGN√ìSTICO EXITOSO! Todo funcionando correctamente', 'success');
                log('‚úÖ El sistema est√° listo para producci√≥n', 'success');
            } else if (totalOk >= totalPossible * 0.7) {
                log('‚ö†Ô∏è DIAGN√ìSTICO PARCIAL: Algunos problemas detectados', 'warning');
                log('üîß Revisa los fallos espec√≠ficos arriba', 'warning');
            } else {
                log('‚ùå DIAGN√ìSTICO FALLIDO: Problemas cr√≠ticos detectados', 'error');
                log('üö® Se requiere intervenci√≥n antes del despliegue', 'error');
            }
            
            // Recomendaciones
            log('');
            log('üí° RECOMENDACIONES:');
            if (connectivityCount === 0) {
                log('   ‚Ä¢ Verifica que los archivos PHP est√©n subidos al servidor', 'warning');
                log('   ‚Ä¢ Comprueba la configuraci√≥n del hosting InfinityFree', 'warning');
            }
            if (corsCount < Object.keys(backendUrls).length) {
                log('   ‚Ä¢ Revisa los headers CORS en los archivos PHP', 'warning');
                log('   ‚Ä¢ Aseg√∫rate de que el servidor procese los headers correctamente', 'warning');
            }
            if (!hasCharlaAI) {
                log('   ‚Ä¢ Verifica que charla.js est√© cargado en la p√°gina', 'warning');
                log('   ‚Ä¢ Comprueba que no haya errores de JavaScript', 'warning');
            }
        }

        function clearLogs() {
            resultsDiv.innerHTML = 'üóëÔ∏è Logs limpiados.\n\nüéØ Sistema listo para nuevos diagn√≥sticos...\n';
            testCount = 0;
            totalTests = 0;
            updateProgress();
            
            // Reset status indicators
            ['status', 'api', 'simple', 'index'].forEach(endpoint => {
                const indicator = document.getElementById(`status-${endpoint}`);
                if (indicator) {
                    indicator.className = 'status-indicator';
                }
            });
        }
    </script>
</body>
</html>
